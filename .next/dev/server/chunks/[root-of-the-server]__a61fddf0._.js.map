{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 18, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/tosib/Downloads/billing-main/billing-main/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\"\r\nimport { Pool } from \"pg\"\r\nimport { PrismaPg } from \"@prisma/adapter-pg\"\r\n\r\ndeclare global {\r\n  var prisma: PrismaClient | undefined\r\n}\r\n\r\nconst pool = new Pool({\r\n  connectionString: process.env.DATABASE_URL,\r\n})\r\n\r\nconst adapter = new PrismaPg(pool)\r\n\r\nexport const prisma =\r\n  global.prisma ||\r\n  new PrismaClient({\r\n    adapter,\r\n  })\r\n\r\nif (process.env.NODE_ENV !== \"production\") {\r\n  global.prisma = prisma\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;;AAMA,MAAM,OAAO,IAAI,qJAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEA,MAAM,UAAU,IAAI,8NAAQ,CAAC;AAEtB,MAAM,SACX,OAAO,MAAM,IACb,IAAI,sMAAY,CAAC;IACf;AACF;AAEF,wCAA2C;IACzC,OAAO,MAAM,GAAG;AAClB"}},
    {"offset": {"line": 50, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/tosib/Downloads/billing-main/billing-main/src/pages/api/sales-today.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from \"next\"\r\nimport { prisma } from \"../../lib/prisma\"\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  console.log(\"üìä DASHBOARD ANALYTICS API HIT\")\r\n\r\n  try {\r\n    const now = new Date()\r\n\r\n    // Today range\r\n    const startToday = new Date()\r\n    startToday.setHours(0,0,0,0)\r\n\r\n    const endToday = new Date()\r\n    endToday.setHours(23,59,59,999)\r\n\r\n    // Week range\r\n    const startWeek = new Date()\r\n    startWeek.setDate(now.getDate() - 7)\r\n\r\n    // Month range\r\n    const startMonth = new Date(now.getFullYear(), now.getMonth(), 1)\r\n\r\n    // Fetch all sales once\r\n    const sales = await prisma.sale.findMany({\r\n  include: {\r\n    items: {\r\n      include: { item:true }   // ‚≠ê join item table\r\n    }\r\n  }\r\n})\r\n\r\n\r\n    // ---- TODAY ----\r\n    const todaySales = sales.filter(s =>\r\n      new Date(s.createdAt) >= startToday &&\r\n      new Date(s.createdAt) <= endToday\r\n    )\r\n\r\n    const todayTotal = todaySales.reduce((s,x)=>s+x.totalAmount,0)\r\n    const todayBills = todaySales.length\r\n\r\n    const cashTotal = todaySales\r\n      .filter(s=>s.paymentMode===\"CASH\")\r\n      .reduce((s,x)=>s+x.totalAmount,0)\r\n\r\n    const upiTotal = todaySales\r\n      .filter(s=>s.paymentMode===\"UPI\")\r\n      .reduce((s,x)=>s+x.totalAmount,0)\r\n\r\n    // ---- WEEK ----\r\n    const weekSales = sales.filter(s => new Date(s.createdAt) >= startWeek)\r\n    const weekTotal = weekSales.reduce((s,x)=>s+x.totalAmount,0)\r\n\r\n    // ---- MONTH ----\r\n    const monthSales = sales.filter(s => new Date(s.createdAt) >= startMonth)\r\n    const monthTotal = monthSales.reduce((s,x)=>s+x.totalAmount,0)\r\n\r\n    // ---- TOP ITEMS ----\r\n    const itemCount:any = {}\r\n\r\nsales.forEach(sale=>{\r\n  sale.items.forEach(i=>{\r\n    const name = i.item.name\r\n    itemCount[name] = (itemCount[name] || 0) + i.qty\r\n  })\r\n})\r\n\r\nconst topItems = Object.entries(itemCount)\r\n  .sort((a:any,b:any)=>b[1]-a[1])\r\n  .slice(0,5)\r\n// HOURLY SALES\r\nconst hourly:any = {}\r\n\r\ntodaySales.forEach(sale=>{\r\n  const hour = new Date(sale.createdAt).getHours()\r\n  hourly[hour] = (hourly[hour] || 0) + sale.totalAmount\r\n})\r\n\r\nconst hourlySales = Object.entries(hourly).map(([hour,total])=>({\r\n  hour: hour+\":00\",\r\n  total\r\n}))\r\n\r\n\r\n    res.status(200).json({\r\n      todayTotal,\r\n      todayBills,\r\n      cashTotal,\r\n      upiTotal,\r\n      weekTotal,\r\n      monthTotal,\r\n      topItems\r\n    })\r\n\r\n  } catch (err) {\r\n    console.log(\"‚ùå ANALYTICS ERROR:\", err)\r\n    res.status(500).json({ error: \"Analytics failed\" })\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}